# 复古收音机 - 开发与使用文档

## 项目简介

这是一款**复古拟物风格的收音机移动应用**，支持收听全国广播电台。采用 Flutter 框架开发，可打包为 Android 和 iOS 应用。

---

## 功能特性

| 功能 | 说明 |
|------|------|
| 📻 广播收听 | 免费收听本地电台和全国性电台 |
| 🔄 在线/离线播放 | 支持在线播放和离线下载节目 |
| 🔍 搜索功能 | 按节目名称、主持人、电台名称搜索 |
| 📂 分类浏览 | 按电台类型、地区、语言分类浏览 |
| ❤️ 收藏功能 | 收藏喜欢的节目、电台、主持人 |
| 📤 分享功能 | 分享节目给朋友 |
| 🌙 夜间模式 | 保护眼睛的深色主题 |
| 🎵 后台播放 | 离开应用后继续播放 |
| 💾 本地存储 | 所有数据保存在本地，无需后端服务器 |

---

## 环境要求

### 必需环境

| 工具 | 版本要求 | 说明 |
|------|----------|------|
| Flutter SDK | >= 3.0.0 | 跨平台开发框架 |
| Dart SDK | >= 3.0.0 | 随 Flutter 自动安装 |
| Android Studio | 最新版 | Android 开发与打包 |
| Xcode | >= 14.0 | iOS 开发与打包（仅 macOS） |

### 可选环境

| 工具 | 说明 |
|------|------|
| VS Code | 推荐 IDE，配合 Flutter 插件 |
| Android SDK | Android 开发工具包 |

### 检查环境

```bash
# 检查 Flutter 是否安装
flutter --version

# 检查环境配置
flutter doctor
```

---

## 快速开始

### 1. 安装依赖

```bash
cd D:\success\code\shou_yin_ji
flutter pub get
```

### 2. 运行调试

```bash
# 运行在连接的设备上（自动选择）
flutter run

# 指定运行在 Android 设备
flutter run -d android

# 指定运行在 iOS 设备（仅 macOS）
flutter run -d ios

# 查看可用设备列表
flutter devices
```

### 3. 热重载

运行调试时，修改代码后按以下快捷键：
- `r` - 热重载（保留应用状态）
- `R` - 热重启（重置应用状态）
- `q` - 退出调试

---

## 构建发布

### Android APK

```bash
# 构建 Release 版本 APK
flutter build apk --release

# 输出位置：build/app/outputs/flutter-apk/app-release.apk
```

### Android App Bundle (推荐用于上架 Google Play)

```bash
# 构建 App Bundle
flutter build appbundle --release

# 输出位置：build/app/outputs/bundle/release/app-release.aab
```

### iOS (仅 macOS)

```bash
# 构建 iOS 应用
flutter build ios --release

# 然后在 Xcode 中打开 ios/Runner.xcworkspace 进行签名和上传
```

### 构建选项

```bash
# 构建调试版本（用于测试）
flutter build apk --debug

# 构建时指定目标平台
flutter build apk --target-platform android-arm64

# 分拆 APK（减小单个包体积）
flutter build apk --split-per-abi
```

---

## 项目结构

```
D:\success\code\shou_yin_ji\
│
├── lib/                          # 主代码目录
│   ├── main.dart                 # 应用入口
│   ├── app.dart                  # MaterialApp 配置
│   │
│   ├── core/                     # 核心模块
│   │   └── theme/
│   │       └── app_theme.dart    # 主题配置（复古配色）
│   │
│   ├── data/                     # 数据层
│   │   ├── models/               # 数据模型
│   │   │   ├── radio_station.dart      # 电台模型
│   │   │   ├── program.dart            # 节目模型
│   │   │   ├── host.dart               # 主持人模型
│   │   │   ├── favorite.dart           # 收藏模型
│   │   │   ├── play_history.dart       # 播放历史模型
│   │   │   ├── download_task.dart      # 下载任务模型
│   │   │   └── app_settings.dart       # 设置模型
│   │   │
│   │   ├── datasources/          # 数据源
│   │   │   ├── local/
│   │   │   │   └── hive_service.dart   # Hive 本地存储
│   │   │   └── remote/
│   │   │       └── built_in_stations.dart  # 内置电台数据
│   │   │
│   │   └── repositories/         # 仓库层
│   │       └── repositories.dart # 数据仓库
│   │
│   ├── services/                 # 服务层
│   │   └── audio/
│   │       └── audio_player_service.dart  # 音频播放服务
│   │
│   ├── features/                 # 功能模块（按页面组织）
│   │   ├── home/                 # 首页
│   │   │   └── home_screen.dart
│   │   ├── player/               # 播放器（核心）
│   │   │   └── player_screen.dart
│   │   ├── search/               # 搜索
│   │   │   └── search_screen.dart
│   │   ├── category/             # 分类浏览
│   │   │   └── category_screen.dart
│   │   ├── favorites/            # 收藏夹
│   │   │   └── favorites_screen.dart
│   │   ├── downloads/            # 下载管理
│   │   │   └── downloads_screen.dart
│   │   ├── history/              # 播放历史
│   │   │   └── history_screen.dart
│   │   └── settings/             # 设置
│   │       └── settings_screen.dart
│   │
│   ├── shared/                   # 共享组件
│   │   └── widgets/              # 复古 UI 组件
│   │       ├── retro_knob.dart       # 复古旋钮
│   │       ├── frequency_dial.dart   # 频率刻度盘
│   │       ├── vu_meter.dart         # VU 音量表
│   │       └── retro_widgets.dart    # 其他复古组件
│   │
│   └── router/                   # 路由
│       └── app_router.dart       # 路由配置
│
├── assets/                       # 静态资源
│   ├── data/
│   │   └── radio_stations.json   # 内置电台数据
│   ├── images/
│   │   ├── textures/             # 纹理图片（木纹、金属等）
│   │   └── icons/                # 图标资源
│   └── fonts/                    # 字体文件
│
├── android/                      # Android 原生配置
│   └── app/src/main/
│       ├── AndroidManifest.xml   # 清单文件（权限配置）
│       └── kotlin/               # Kotlin 原生代码
│
├── ios/                          # iOS 原生配置
│   └── Runner/
│       ├── Info.plist            # 配置文件（权限配置）
│       └── AppDelegate.swift     # Swift 原生代码
│
├── pubspec.yaml                  # 依赖配置
├── analysis_options.yaml         # 代码分析配置
└── README.md                     # 项目说明
```

---

## 技术栈

### 核心框架

| 技术 | 版本 | 用途 |
|------|------|------|
| Flutter | >= 3.0.0 | 跨平台 UI 框架 |
| Dart | >= 3.0.0 | 编程语言 |

### 主要依赖

| 依赖包 | 版本 | 用途 |
|--------|------|------|
| flutter_riverpod | ^2.4.9 | 状态管理 |
| hive | ^2.2.3 | 本地 NoSQL 数据库 |
| hive_flutter | ^1.1.0 | Hive Flutter 集成 |
| just_audio | ^0.9.36 | 音频播放引擎 |
| just_audio_background | ^0.0.1-beta.11 | 后台播放服务 |
| audio_session | ^0.1.18 | 音频会话管理 |
| dio | ^5.4.0 | HTTP 网络请求 |
| share_plus | ^7.2.1 | 系统分享功能 |
| flutter_animate | ^4.3.0 | 动画效果库 |
| path_provider | ^2.1.1 | 文件路径获取 |
| shared_preferences | ^2.2.2 | 简单配置存储 |
| connectivity_plus | ^5.0.2 | 网络状态检测 |
| flutter_downloader | ^1.11.4 | 文件下载管理 |
| permission_handler | ^11.1.0 | 权限管理 |

---

## 复古 UI 组件

### 1. RetroKnob - 复古旋钮

用于调节音量等参数，支持拖动手势，有阻尼感。

```dart
RetroKnob(
  value: 0.7,           // 当前值 (0.0 - 1.0)
  size: 80,             // 旋钮大小
  knobColor: Color(0xFF444444),   // 旋钮颜色
  indicatorColor: Color(0xFFB8860B), // 指示器颜色
  onChanged: (value) {  // 值变化回调
    // 处理音量变化
  },
)
```

### 2. FrequencyDial - 频率刻度盘

显示 FM 频率刻度，带指针动画。

```dart
FrequencyDial(
  frequency: 98.6,      // 当前频率
  minFrequency: 87.5,   // 最小频率
  maxFrequency: 108.0,  // 最大频率
  isPlaying: true,      // 是否播放中
)
```

### 3. VUMeter - VU 音量表

实时显示音量电平，支持立体声模式。

```dart
VUMeter(
  level: 0.6,           // 音量电平 (0.0 - 1.0)
  isStereo: true,       // 是否立体声
  width: 200,
  height: 30,
)
```

### 4. FrequencyDisplay - 频率显示

LED 风格的频率数字显示。

```dart
FrequencyDisplay(
  frequency: '106.1',   // 频率字符串
  stationName: '中国之声', // 电台名称
  isPlaying: true,      // 是否播放中
)
```

### 5. GlowingIndicator - 发光指示灯

显示播放状态的发光指示灯。

```dart
GlowingIndicator(
  isOn: true,           // 是否亮起
  onColor: Color(0xFF00FF00),  // 亮起颜色
  size: 12,
  label: 'ON AIR',      // 标签文字
)
```

### 6. WoodenPanel - 木纹面板

复古木纹背景面板。

```dart
WoodenPanel(
  child: YourWidget(),  // 子组件
  padding: EdgeInsets.all(16),
)
```

---

## 内置电台数据

### 电台列表 (30+)

| 分类 | 电台 |
|------|------|
| **中央台** | 中国之声(FM 106.1)、经济之声(FM 96.6)、音乐之声(FM 99.0)、都市之声(FM 101.8)、文艺之声(FM 87.8) |
| **国际台** | 环球资讯(FM 91.5)、轻松调频(FM 88.7)、Hit FM(FM 90.5) |
| **北京** | 新闻广播(FM 100.6)、交通广播(FM 103.9)、音乐广播(FM 97.4)、故事广播(FM 95.4) |
| **上海** | 新闻广播(FM 93.4)、交通广播(FM 105.7)、动感101(FM 101.7)、经典音乐(FM 94.7) |
| **广东** | 新闻广播(FM 91.4)、音乐之声(FM 99.3)、羊城交通(FM 105.2) |
| **浙江** | 浙江之声(FM 88.0)、交通之声(FM 93.0)、音乐调频(FM 96.8) |
| **江苏** | 新闻广播(FM 93.7)、交通广播(FM 101.1)、经典流行(FM 89.7) |
| **其他省市** | 四川、湖南、湖北、河南、山东、福建、陕西、辽宁、天津、重庆等 |

### 分类维度

- **按类型**: 新闻、音乐、交通、经济、文艺、都市、体育、故事、方言
- **按地区**: 全国、北京、上海、广东、浙江、江苏等 16 个省市
- **按语言**: 普通话、粤语、英语、闽南语、吴语

### 电台数据格式

```json
{
  "id": "cnr_zgzs",
  "name": "中央人民广播电台",
  "frequency": "FM 106.1",
  "streamUrl": "http://ngcdn001.cnr.cn/live/zgzs/index.m3u8",
  "category": "新闻",
  "region": "全国",
  "language": "普通话",
  "isNational": true,
  "description": "中国之声 - 中央人民广播电台第一套节目"
}
```

---

## 权限配置

### Android 权限

位置：`android/app/src/main/AndroidManifest.xml`

```xml
<!-- 网络权限 -->
<uses-permission android:name="android.permission.INTERNET"/>
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>

<!-- 存储权限 -->
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>

<!-- 后台播放权限 -->
<uses-permission android:name="android.permission.WAKE_LOCK"/>
<uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK"/>
```

### iOS 权限

位置：`ios/Runner/Info.plist`

```xml
<!-- 后台音频播放 -->
<key>UIBackgroundModes</key>
<array>
    <string>audio</string>
    <string>fetch</string>
</array>

<!-- 网络配置 -->
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSAllowsArbitraryLoads</key>
    <true/>
</dict>
```

---

## 开发调试

### 常用命令

```bash
# 清理构建缓存
flutter clean

# 重新获取依赖
flutter pub get

# 代码静态分析
flutter analyze

# 运行测试
flutter test

# 查看依赖树
flutter pub deps

# 升级依赖
flutter pub upgrade

# 格式化代码
dart format .
```

### 日志调试

```dart
import 'package:logger/logger.dart';

final logger = Logger();

logger.d('Debug message');
logger.i('Info message');
logger.w('Warning message');
logger.e('Error message');
```

### 性能分析

```bash
# 打开性能面板
flutter run --profile
# 然后按 'p' 键打开性能叠加层
```

---

## 常见问题

### 1. Flutter SDK 未找到

```
错误: 'flutter' 不是内部或外部命令
```

**解决方案**：
1. 下载 Flutter SDK: https://flutter.dev/docs/get-started/install
2. 解压到目标目录（如 `C:\flutter`）
3. 添加到系统环境变量 PATH

### 2. Android 依赖下载失败

```
错误: Could not resolve all files for configuration ':app:debugRuntimeClasspath'
```

**解决方案**：
- 检查网络连接
- 配置国内镜像源（修改 `android/build.gradle`）

### 3. iOS 签名问题

```
错误: No valid signing certificates found
```

**解决方案**：
1. 打开 Xcode
2. 选择 Runner 项目
3. 在 Signing & Capabilities 中配置开发者账号

### 4. 后台播放不工作

**解决方案**：
- 确认 Android 权限已配置
- 确认 iOS Info.plist 已配置 UIBackgroundModes
- 检查电池优化设置

### 5. 电台无法播放

**解决方案**：
- 检查网络连接
- 部分电台流地址可能已失效，需要更新
- 尝试使用其他网络（如 WiFi）

---

## 扩展开发

### 添加新电台

编辑 `lib/data/datasources/remote/built_in_stations.dart`:

```dart
RadioStation(
  id: 'unique_id',
  name: '电台名称',
  frequency: 'FM XX.X',
  streamUrl: 'http://stream-url.m3u8',
  category: '分类',
  region: '地区',
  language: '语言',
  isNational: false,
  description: '电台描述',
),
```

### 添加新页面

1. 创建页面文件：`lib/features/new_feature/new_screen.dart`
2. 添加路由：`lib/router/app_router.dart`
3. 导入页面类

### 自定义主题颜色

编辑 `lib/core/theme/app_theme.dart`:

```dart
class AppTheme {
  // 修改这些颜色值来自定义主题
  static const Color woodBrown = Color(0xFF8B4513);
  static const Color brass = Color(0xFFB8860B);
  // ...
}
```

---

## 发布上架

### Android

1. **生成签名密钥**：
```bash
keytool -genkey -v -keystore release-key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias retro-radio
```

2. **配置签名**：创建 `android/key.properties`

3. **构建发布版**：
```bash
flutter build apk --release
```

4. **上架应用商店**：
   - 国内：华为、小米、OPPO、vivo、应用宝等开发者平台
   - 海外：Google Play Console

### iOS

1. **配置签名**：在 Xcode 中配置 Apple Developer 账号

2. **构建发布版**：
```bash
flutter build ios --release
```

3. **上传 App Store**：
```bash
# 或在 Xcode 中 Product > Archive > Distribute App
```

---

## 联系与反馈

如有问题或建议，请通过以下方式反馈：
- 项目 Issues
- 应用内意见反馈功能

---

*文档版本: 1.0.0*
*最后更新: 2024年*
